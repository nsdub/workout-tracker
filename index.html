<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#F5F1EB">
<title>Protocol</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-base: #F5F1EB;
  --bg-card: #FDFBF7;
  --bg-input: #EDE8E0;
  --bg-hover: #E5DFD5;
  --accent: #B8704B;
  --accent-soft: rgba(184, 112, 75, 0.12);
  --sage: #7D9B76;
  --sage-soft: rgba(125, 155, 118, 0.12);
  --taupe: #9B8F82;
  --sand: #C4B7A6;
  --cream: #FAF7F2;
  --text-dark: #3D3530;
  --text-mid: #6B5F54;
  --text-light: #9A8F82;
  --border: #DDD6CA;
}
[data-theme="dark"] {
  --bg-base: #1C1917;
  --bg-card: #292524;
  --bg-input: #3D3835;
  --bg-hover: #4A4340;
  --accent: #CD7F5A;
  --accent-soft: rgba(205, 127, 90, 0.15);
  --sage: #8BA883;
  --sage-soft: rgba(139, 168, 131, 0.15);
  --taupe: #A89B8E;
  --sand: #BFB2A1;
  --cream: #F5F0E8;
  --text-dark: #F5F0E8;
  --text-mid: #C4BAB0;
  --text-light: #8A7F72;
  --border: #3D3835;
}
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { 
  font-family: 'DM Sans', sans-serif; 
  background: var(--bg-base); 
  color: var(--text-dark);
  min-height: 100vh;
  line-height: 1.4;
}
.container { max-width: 500px; margin: 0 auto; padding: 16px; padding-bottom: 90px; }

header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 8px 0 20px;
}
.logo { font-family: 'DM Mono', monospace; font-size: 15px; font-weight: 500; color: var(--accent); letter-spacing: 2px; }
.theme-btn { background: none; border: none; font-size: 18px; cursor: pointer; padding: 8px; }

/* Workout Selection Grid */
.workout-grid {
  display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
  margin-bottom: 20px;
}
.workout-btn {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
  padding: 14px 12px; text-align: left; cursor: pointer; transition: all 0.15s;
}
.workout-btn:hover { background: var(--bg-hover); }
.workout-btn.active { background: var(--accent-soft); border-color: var(--accent); }
.workout-btn-name { font-weight: 600; font-size: 14px; color: var(--text-dark); }
.workout-btn-focus { font-size: 11px; color: var(--text-light); margin-top: 2px; }

/* Exercise Card */
.exercise {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
  padding: 14px 16px; margin-bottom: 12px;
}
.exercise-header {
  display: flex; justify-content: space-between; align-items: baseline;
  margin-bottom: 10px;
}
.exercise-name { font-weight: 600; font-size: 15px; color: var(--text-dark); }
.exercise-meta { font-size: 12px; color: var(--text-light); }

.last-session {
  font-size: 11px; color: var(--sage); font-weight: 500;
  padding: 6px 10px; background: var(--sage-soft); border-radius: 6px;
  margin-bottom: 10px; font-family: 'DM Mono', monospace;
}

.sets { display: flex; flex-direction: column; gap: 6px; }
.set-row { display: flex; align-items: center; gap: 6px; }
.set-num {
  width: 18px; font-size: 11px; color: var(--text-light); 
  font-family: 'DM Mono', monospace; flex-shrink: 0;
}
.set-inputs { display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0; }
.set-input {
  width: 0; flex: 1; padding: 10px 8px; background: var(--bg-input); 
  border: 1px solid var(--border); border-radius: 6px;
  font-family: 'DM Mono', monospace; font-size: 14px;
  color: var(--text-dark); text-align: center;
}
.set-input:focus { outline: none; border-color: var(--accent); }
.set-input::placeholder { color: var(--text-light); }
.x-sep { color: var(--text-light); font-size: 12px; flex-shrink: 0; }

/* Session Info */
.session-card {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
  padding: 14px 16px; margin-bottom: 12px;
}
.session-title {
  font-size: 11px; font-weight: 600; color: var(--taupe); 
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;
}
.input-row { display: flex; gap: 10px; margin-bottom: 10px; }
.input-group { flex: 1; }
.input-label { font-size: 11px; color: var(--text-mid); margin-bottom: 4px; display: block; }
.input-field {
  width: 100%; padding: 10px 12px; background: var(--bg-input); 
  border: 1px solid var(--border); border-radius: 6px;
  font-size: 14px; color: var(--text-dark);
}
.input-field:focus { outline: none; border-color: var(--accent); }
textarea.input-field { min-height: 60px; resize: vertical; font-family: 'DM Sans', sans-serif; }

.btn {
  width: 100%; padding: 14px; background: var(--accent); border: none; border-radius: 10px;
  font-size: 15px; font-weight: 600; color: #fff; cursor: pointer;
}
.btn:active { opacity: 0.9; transform: scale(0.99); }
.btn-secondary { background: var(--bg-input); color: var(--text-dark); border: 1px solid var(--border); }

/* Navigation */
.nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--bg-card); border-top: 1px solid var(--border);
  display: flex; justify-content: center;
  padding: 10px 16px; padding-bottom: max(10px, env(safe-area-inset-bottom));
}
.nav-inner { display: flex; gap: 6px; max-width: 500px; width: 100%; }
.nav-btn {
  flex: 1; padding: 8px; background: transparent; border: none; border-radius: 8px;
  font-size: 11px; font-weight: 500; color: var(--text-light); cursor: pointer;
  display: flex; flex-direction: column; align-items: center; gap: 3px;
}
.nav-btn.active { color: var(--accent); background: var(--accent-soft); }
.nav-icon { font-size: 16px; }

.hidden { display: none !important; }

/* History */
.history-item { padding: 12px 0; border-bottom: 1px solid var(--border); }
.history-item:last-child { border-bottom: none; }
.history-date { font-size: 11px; color: var(--text-light); font-family: 'DM Mono', monospace; }
.history-name { font-weight: 600; font-size: 14px; margin: 3px 0; }
.history-stats { font-size: 12px; color: var(--text-mid); }

.empty { text-align: center; padding: 30px; color: var(--text-light); font-size: 14px; }

.autosave {
  position: fixed; top: 16px; right: 16px; padding: 6px 12px;
  background: var(--sage); color: #fff; border-radius: 6px;
  font-size: 11px; font-weight: 500; opacity: 0; transition: opacity 0.2s;
}
.autosave.show { opacity: 1; }
</style>
</head>
<body>
<div class="autosave" id="autosave">âœ“ Saved</div>

<div class="container">
  <header>
    <div class="logo">PROTOCOL</div>
    <button class="theme-btn" id="themeBtn">ðŸŒ™</button>
  </header>

  <!-- WORKOUT VIEW -->
  <section id="workoutView">
    <div class="workout-grid" id="workoutGrid"></div>
    <div id="exerciseList"></div>
    <div id="sessionSection" class="hidden">
      <div class="session-card">
        <div class="session-title">Session</div>
        <div class="input-row">
          <div class="input-group">
            <label class="input-label">Bodyweight</label>
            <input type="number" class="input-field" id="bodyweight" inputmode="decimal" placeholder="lbs">
          </div>
          <div class="input-group">
            <label class="input-label">Readiness</label>
            <input type="number" class="input-field" id="readiness" inputmode="numeric" min="1" max="10" placeholder="1-10">
          </div>
        </div>
        <div class="input-group">
          <label class="input-label">Notes</label>
          <textarea class="input-field" id="notes" placeholder="Optional"></textarea>
        </div>
      </div>
      <button class="btn" id="saveBtn">Save Workout</button>
    </div>
  </section>

  <!-- HISTORY VIEW -->
  <section id="historyView" class="hidden">
    <div class="session-card">
      <div class="session-title">History</div>
      <div id="historyList"></div>
    </div>
    <button class="btn btn-secondary" id="exportBtn" style="margin-top:12px;">Export for Analysis</button>
  </section>

  <!-- PROGRAM VIEW -->
  <section id="programView" class="hidden">
    <div class="session-card">
      <div class="session-title">Current Program</div>
      <div id="programInfo"></div>
    </div>
    <div class="session-card" style="margin-top:12px;">
      <div class="session-title">Update Program</div>
      <textarea class="input-field" id="programJson" rows="5" placeholder="Paste plan.json"></textarea>
      <button class="btn" id="updateBtn" style="margin-top:10px;">Update</button>
    </div>
  </section>
</div>

<nav class="nav">
  <div class="nav-inner">
    <button class="nav-btn active" data-view="workout"><span class="nav-icon">ðŸ’ª</span>Workout</button>
    <button class="nav-btn" data-view="history"><span class="nav-icon">ðŸ“Š</span>History</button>
    <button class="nav-btn" data-view="program"><span class="nav-icon">ðŸ“‹</span>Program</button>
  </div>
</nav>

<script>
const DEFAULT_PLAN={"version":"2.0","workouts":{"Push A":{"focus":"Chest","exercises":[{"name":"Smith Incline Press","sets":4,"repRange":"8-12"},{"name":"Machine Chest Press","sets":3,"repRange":"10-12"},{"name":"Cable Crossover (Low-High)","sets":3,"repRange":"12-15"},{"name":"DB Shoulder Press","sets":3,"repRange":"10-12"},{"name":"Cable Lateral Raise","sets":3,"repRange":"12-15"},{"name":"Overhead Tricep Extension","sets":3,"repRange":"10-12"},{"name":"Cable Pushdown","sets":3,"repRange":"10-12"},{"name":"Face Pulls","sets":2,"repRange":"15-20"}]},"Push B":{"focus":"Shoulders","exercises":[{"name":"Smith Overhead Press","sets":4,"repRange":"6-10"},{"name":"DB Lateral Raise","sets":3,"repRange":"12-15"},{"name":"Cable Crossover (High-Low)","sets":3,"repRange":"12-15"},{"name":"Machine Chest Press","sets":3,"repRange":"10-12"},{"name":"Reverse Pec Deck","sets":3,"repRange":"12-15"},{"name":"Assisted Dips","sets":3,"repRange":"8-12"},{"name":"Overhead Tricep Extension","sets":3,"repRange":"10-12"},{"name":"Face Pulls","sets":2,"repRange":"15-20"}]},"Pull A":{"focus":"Width","exercises":[{"name":"Deadlift","sets":4,"repRange":"5-8"},{"name":"Wide Lat Pulldown","sets":3,"repRange":"8-12"},{"name":"Wide Cable Row","sets":3,"repRange":"10-12"},{"name":"DB Curl","sets":3,"repRange":"10-12"},{"name":"Cable Hammer Curl","sets":3,"repRange":"10-12"},{"name":"Face Pulls","sets":2,"repRange":"15-20"}]},"Pull B":{"focus":"Thickness","exercises":[{"name":"Smith Bent Row","sets":4,"repRange":"8-10"},{"name":"Close Grip Pulldown","sets":3,"repRange":"10-12"},{"name":"Straight Arm Pulldown","sets":3,"repRange":"12-15"},{"name":"DB Shrug","sets":3,"repRange":"12-15"},{"name":"Incline DB Curl","sets":3,"repRange":"10-12"},{"name":"Cable Reverse Curl","sets":3,"repRange":"12-15"},{"name":"Face Pulls","sets":2,"repRange":"15-20"}]},"Legs A":{"focus":"Quads","exercises":[{"name":"Leg Press (Low Feet)","sets":4,"repRange":"10-12"},{"name":"Leg Extension","sets":4,"repRange":"10-15"},{"name":"Hip Adductor","sets":2,"repRange":"12-15"},{"name":"Hip Abductor","sets":2,"repRange":"12-15"},{"name":"Standing Calf Raise","sets":4,"repRange":"12-15"},{"name":"Cable Crunch","sets":3,"repRange":"12-15"},{"name":"Hanging Leg Raise","sets":3,"repRange":"12-15"}]},"Legs B":{"focus":"Posterior","exercises":[{"name":"Smith RDL","sets":4,"repRange":"8-10"},{"name":"Leg Press (High Feet)","sets":3,"repRange":"10-12"},{"name":"Leg Curl","sets":4,"repRange":"10-12"},{"name":"Hip Adductor","sets":2,"repRange":"12-15"},{"name":"Hip Abductor","sets":2,"repRange":"12-15"},{"name":"Standing Calf Raise","sets":4,"repRange":"12-15"},{"name":"Cable Crunch","sets":3,"repRange":"12-15"},{"name":"Plank","sets":2,"repRange":"45-60s"}]},"Rest":{"focus":"Recovery","exercises":[]}}};

let plan = JSON.parse(localStorage.getItem('protocol-plan')) || DEFAULT_PLAN;
let history = JSON.parse(localStorage.getItem('protocol-history')) || [];
let form = JSON.parse(localStorage.getItem('protocol-form')) || {};
let theme = localStorage.getItem('protocol-theme') || 'light';
let currentWorkout = null;

document.addEventListener('DOMContentLoaded', () => {
  applyTheme(theme);
  renderWorkoutGrid();
  initNav();
  initListeners();
  autoSelectWorkout();
});

function applyTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  document.getElementById('themeBtn').textContent = t === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
}

function renderWorkoutGrid() {
  const grid = document.getElementById('workoutGrid');
  grid.innerHTML = Object.keys(plan.workouts).filter(w => w !== 'Rest').map(w => {
    const workout = plan.workouts[w];
    return `<button class="workout-btn" data-workout="${w}">
      <div class="workout-btn-name">${w}</div>
      <div class="workout-btn-focus">${workout.focus || ''}</div>
    </button>`;
  }).join('');
  
  grid.querySelectorAll('.workout-btn').forEach(btn => {
    btn.addEventListener('click', () => selectWorkout(btn.dataset.workout));
  });
}

function getSuggestedWorkout() {
  const rotation = ['Push A', 'Pull A', 'Legs A', 'Push B', 'Pull B', 'Legs B'];
  if (history.length === 0) return 'Push A';
  
  const last = history[0];
  const lastIdx = rotation.indexOf(last.workout);
  if (lastIdx === -1) return 'Push A';
  
  const hoursSince = (Date.now() - new Date(last.date).getTime()) / (1000 * 60 * 60);
  if (hoursSince < 20) return null; // Rest
  
  return rotation[(lastIdx + 1) % rotation.length];
}

function autoSelectWorkout() {
  const suggested = getSuggestedWorkout();
  if (suggested && plan.workouts[suggested]) {
    selectWorkout(suggested);
  }
}

function selectWorkout(name) {
  currentWorkout = name;
  
  // Update button states
  document.querySelectorAll('.workout-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.workout === name);
  });
  
  loadExercises(name);
}

function loadExercises(name) {
  const list = document.getElementById('exerciseList');
  const session = document.getElementById('sessionSection');
  const workout = plan.workouts[name];
  
  if (!workout || !workout.exercises || workout.exercises.length === 0) {
    list.innerHTML = '<div class="empty">Rest day - recover well</div>';
    session.classList.add('hidden');
    return;
  }
  
  const lastSession = history.find(h => h.workout === name);
  
  list.innerHTML = workout.exercises.map((ex, i) => {
    const lastEx = lastSession?.exercises?.find(e => e.name === ex.name);
    const formKey = `${name}-${i}`;
    const saved = form[formKey] || [];
    
    let html = `<div class="exercise">
      <div class="exercise-header">
        <div class="exercise-name">${ex.name}</div>
        <div class="exercise-meta">${ex.sets}Ã—${ex.repRange}</div>
      </div>`;
    
    if (lastEx?.sets?.length) {
      html += `<div class="last-session">Last: ${lastEx.sets.map(s => s.weight+'Ã—'+s.reps).join(', ')}</div>`;
    }
    
    html += `<div class="sets">`;
    for (let s = 0; s < ex.sets; s++) {
      const sv = saved[s] || {};
      const wPh = lastEx?.sets?.[s]?.weight || '';
      const rPh = lastEx?.sets?.[s]?.reps || '';
      html += `<div class="set-row">
        <span class="set-num">${s+1}</span>
        <div class="set-inputs">
          <input type="number" class="set-input" data-ex="${i}" data-set="${s}" data-field="weight" 
                 inputmode="decimal" placeholder="${wPh || 'lbs'}" value="${sv.weight || ''}">
          <span class="x-sep">Ã—</span>
          <input type="number" class="set-input" data-ex="${i}" data-set="${s}" data-field="reps" 
                 inputmode="numeric" placeholder="${rPh || 'reps'}" value="${sv.reps || ''}">
        </div>
      </div>`;
    }
    html += `</div></div>`;
    return html;
  }).join('');
  
  session.classList.remove('hidden');
  
  // Restore session fields
  if (form.bodyweight) document.getElementById('bodyweight').value = form.bodyweight;
  if (form.readiness) document.getElementById('readiness').value = form.readiness;
  if (form.notes) document.getElementById('notes').value = form.notes;
  
  // Add listeners
  list.querySelectorAll('.set-input').forEach(inp => {
    inp.addEventListener('input', () => {
      const key = `${name}-${inp.dataset.ex}`;
      if (!form[key]) form[key] = [];
      if (!form[key][inp.dataset.set]) form[key][inp.dataset.set] = {};
      form[key][inp.dataset.set][inp.dataset.field] = inp.value;
      saveForm();
      showSave();
    });
  });
}

function saveForm() {
  localStorage.setItem('protocol-form', JSON.stringify(form));
}

function showSave() {
  const el = document.getElementById('autosave');
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 1000);
}

function initNav() {
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const v = btn.dataset.view;
      document.getElementById('workoutView').classList.toggle('hidden', v !== 'workout');
      document.getElementById('historyView').classList.toggle('hidden', v !== 'history');
      document.getElementById('programView').classList.toggle('hidden', v !== 'program');
      if (v === 'history') renderHistory();
      if (v === 'program') renderProgram();
    });
  });
}

function initListeners() {
  document.getElementById('themeBtn').addEventListener('click', () => {
    theme = theme === 'dark' ? 'light' : 'dark';
    localStorage.setItem('protocol-theme', theme);
    applyTheme(theme);
  });
  
  ['bodyweight', 'readiness', 'notes'].forEach(id => {
    document.getElementById(id).addEventListener('input', e => {
      form[id] = e.target.value;
      saveForm();
      showSave();
    });
  });
  
  document.getElementById('saveBtn').addEventListener('click', saveWorkout);
  document.getElementById('exportBtn').addEventListener('click', exportHistory);
  document.getElementById('updateBtn').addEventListener('click', updateProgram);
}

function saveWorkout() {
  if (!currentWorkout) return alert('Select a workout');
  
  const workout = plan.workouts[currentWorkout];
  const exercises = [];
  
  workout.exercises.forEach((ex, i) => {
    const key = `${currentWorkout}-${i}`;
    const sets = (form[key] || []).filter(s => s && (s.weight || s.reps)).map(s => ({
      weight: parseFloat(s.weight) || 0,
      reps: parseInt(s.reps) || 0
    }));
    if (sets.length) exercises.push({ name: ex.name, sets });
  });
  
  if (!exercises.length) return alert('Log at least one set');
  
  history.unshift({
    id: Date.now(),
    date: new Date().toISOString(),
    workout: currentWorkout,
    exercises,
    bodyweight: parseFloat(document.getElementById('bodyweight').value) || null,
    readiness: parseInt(document.getElementById('readiness').value) || null,
    notes: document.getElementById('notes').value || null
  });
  
  localStorage.setItem('protocol-history', JSON.stringify(history));
  
  // Clear form
  Object.keys(form).forEach(k => { if (k.startsWith(currentWorkout)) delete form[k]; });
  form.bodyweight = ''; form.readiness = ''; form.notes = '';
  saveForm();
  
  document.getElementById('bodyweight').value = '';
  document.getElementById('readiness').value = '';
  document.getElementById('notes').value = '';
  
  alert('Saved!');
  
  // Move to next workout
  const rotation = ['Push A', 'Pull A', 'Legs A', 'Push B', 'Pull B', 'Legs B'];
  const idx = rotation.indexOf(currentWorkout);
  const next = rotation[(idx + 1) % rotation.length];
  selectWorkout(next);
}

function renderHistory() {
  const el = document.getElementById('historyList');
  if (!history.length) {
    el.innerHTML = '<div class="empty">No workouts yet</div>';
    return;
  }
  el.innerHTML = history.slice(0, 30).map(h => {
    const d = new Date(h.date);
    const sets = h.exercises.reduce((a, e) => a + e.sets.length, 0);
    const vol = h.exercises.reduce((a, e) => a + e.sets.reduce((b, s) => b + s.weight * s.reps, 0), 0);
    return `<div class="history-item">
      <div class="history-date">${d.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'})}</div>
      <div class="history-name">${h.workout}</div>
      <div class="history-stats">${sets} sets Â· ${Math.round(vol).toLocaleString()} lbs</div>
    </div>`;
  }).join('');
}

function exportHistory() {
  let txt = '# WORKOUT HISTORY\n\n';
  history.forEach(h => {
    const d = new Date(h.date);
    txt += `## ${h.workout} - ${d.toLocaleDateString()}\n`;
    if (h.bodyweight) txt += `Bodyweight: ${h.bodyweight}\n`;
    h.exercises.forEach(e => {
      txt += `\n${e.name}:\n`;
      e.sets.forEach((s, i) => txt += `  ${i+1}. ${s.weight} Ã— ${s.reps}\n`);
    });
    if (h.notes) txt += `\nNotes: ${h.notes}\n`;
    txt += '\n---\n\n';
  });
  navigator.clipboard.writeText(txt).then(() => alert('Copied to clipboard'));
}

function renderProgram() {
  document.getElementById('programInfo').innerHTML = `
    <p style="margin-bottom:8px;"><strong>Version:</strong> ${plan.version || '1.0'}</p>
    <p><strong>Workouts:</strong> ${Object.keys(plan.workouts).filter(w=>w!=='Rest').join(', ')}</p>
  `;
}

function updateProgram() {
  const json = document.getElementById('programJson').value.trim();
  if (!json) return;
  try {
    const p = JSON.parse(json);
    if (!p.workouts) throw new Error('Missing workouts');
    plan = p;
    localStorage.setItem('protocol-plan', JSON.stringify(plan));
    renderWorkoutGrid();
    renderProgram();
    document.getElementById('programJson').value = '';
    alert('Updated!');
  } catch(e) {
    alert('Invalid JSON: ' + e.message);
  }
}
</script>
</body>
</html>
