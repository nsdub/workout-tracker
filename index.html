<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2D2926">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Protocol</title>
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Source+Sans+3:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #1F1C1A;
      --bg-main: #2D2926;
      --bg-card: #3A3430;
      --bg-elevated: #4A433D;
      --terracotta: #C7633E;
      --terracotta-muted: #A5543A;
      --sage: #8B9D77;
      --sage-muted: #6B7D5A;
      --sand: #D9CAB3;
      --clay: #B5846E;
      --cream: #F5F0E8;
      --warm-white: #E8E2D9;
      --text-primary: #F5F0E8;
      --text-secondary: #B8AFA3;
      --text-muted: #7A7269;
      --success: #8B9D77;
      --warning: #D4A84B;
      --danger: #C7633E;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --font-display: 'Libre Baskerville', Georgia, serif;
      --font-body: 'Source Sans 3', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      font-family: var(--font-body);
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }
    body {
      padding-bottom: 90px;
      background: 
        radial-gradient(ellipse at 20% 0%, rgba(199, 99, 62, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(139, 157, 119, 0.06) 0%, transparent 50%),
        var(--bg-deep);
    }
    .header {
      padding: 20px 16px 16px;
      background: linear-gradient(to bottom, var(--bg-main), transparent);
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .logo {
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 700;
      color: var(--cream);
      letter-spacing: -0.5px;
    }
    .week-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-card);
      padding: 8px 14px;
      border-radius: 20px;
      border: 1px solid var(--bg-elevated);
    }
    .week-badge .number {
      font-family: var(--font-mono);
      font-size: 18px;
      font-weight: 500;
      color: var(--terracotta);
    }
    .week-badge .label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .phase-banner {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 3px solid var(--sage);
    }
    .phase-info .phase-name {
      font-family: var(--font-display);
      font-size: 15px;
      color: var(--cream);
      margin-bottom: 2px;
    }
    .phase-info .phase-detail {
      font-size: 12px;
      color: var(--text-muted);
    }
    .phase-progress {
      text-align: right;
    }
    .phase-progress .bar {
      width: 80px;
      height: 4px;
      background: var(--bg-elevated);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 4px;
    }
    .phase-progress .bar-fill {
      height: 100%;
      background: var(--sage);
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    .phase-progress .text {
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-muted);
    }
    .alerts {
      padding: 0 16px;
      margin-top: 12px;
    }
    .alert {
      background: rgba(199, 99, 62, 0.15);
      border: 1px solid rgba(199, 99, 62, 0.3);
      border-radius: var(--radius-md);
      padding: 12px 14px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .alert.warning {
      background: rgba(212, 168, 75, 0.15);
      border-color: rgba(212, 168, 75, 0.3);
    }
    .alert.info {
      background: rgba(139, 157, 119, 0.15);
      border-color: rgba(139, 157, 119, 0.3);
    }
    .alert-icon { font-size: 16px; flex-shrink: 0; }
    .alert-content { flex: 1; }
    .alert-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--cream);
      margin-bottom: 2px;
    }
    .alert-text {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    .alert-dismiss {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      padding: 16px;
    }
    .stat-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 14px 12px;
      text-align: center;
      border: 1px solid transparent;
      transition: border-color 0.2s;
    }
    .stat-value {
      font-family: var(--font-mono);
      font-size: 22px;
      font-weight: 500;
      color: var(--cream);
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .tabs {
      display: flex;
      padding: 0 16px;
      gap: 4px;
      margin-bottom: 16px;
    }
    .tab {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-family: var(--font-body);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-radius: var(--radius-md);
      transition: all 0.2s;
    }
    .tab.active {
      background: var(--bg-card);
      color: var(--cream);
    }
    .content { padding: 0 16px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .workout-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .workout-btn {
      background: var(--bg-card);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      padding: 16px 12px;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }
    .workout-btn:hover { background: var(--bg-elevated); }
    .workout-btn.selected {
      border-color: var(--terracotta);
      background: rgba(199, 99, 62, 0.1);
    }
    .workout-btn .name {
      font-family: var(--font-display);
      font-size: 15px;
      color: var(--cream);
      margin-bottom: 4px;
    }
    .workout-btn .focus {
      font-size: 12px;
      color: var(--text-muted);
    }
    .workout-btn.rest {
      grid-column: span 2;
      text-align: center;
      background: var(--bg-elevated);
    }
    .exercise-section { margin-bottom: 24px; }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .section-title {
      font-family: var(--font-display);
      font-size: 16px;
      color: var(--cream);
    }
    .section-count {
      font-size: 12px;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }
    .exercise-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      overflow: hidden;
    }
    .exercise-header {
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .exercise-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--cream);
    }
    .exercise-target {
      font-size: 12px;
      font-family: var(--font-mono);
      color: var(--text-muted);
    }
    .exercise-sets {
      padding: 0 16px 16px;
      display: none;
    }
    .exercise-card.expanded .exercise-sets { display: block; }
    .exercise-note {
      font-size: 11px;
      color: var(--clay);
      margin-bottom: 12px;
      font-style: italic;
    }
    .sets-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .set-input-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .set-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .set-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-elevated);
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
      color: var(--cream);
      font-family: var(--font-mono);
      font-size: 15px;
      text-align: center;
      transition: border-color 0.2s;
    }
    .set-input:focus {
      outline: none;
      border-color: var(--terracotta-muted);
    }
    .set-input::placeholder { color: var(--text-muted); }
    .set-input.filled {
      border-color: var(--sage-muted);
      background: rgba(139, 157, 119, 0.1);
    }
    .metrics-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    .metric-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 14px;
    }
    .metric-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .metric-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-elevated);
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
      color: var(--cream);
      font-family: var(--font-mono);
      font-size: 16px;
      transition: border-color 0.2s;
    }
    .metric-input:focus {
      outline: none;
      border-color: var(--terracotta-muted);
    }
    .energy-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 20px;
    }
    .energy-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .energy-label {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .energy-value {
      font-family: var(--font-mono);
      font-size: 18px;
      font-weight: 500;
      color: var(--cream);
    }
    .energy-slider {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--bg-elevated);
      border-radius: 4px;
      outline: none;
    }
    .energy-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      background: var(--terracotta);
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid var(--cream);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .energy-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      background: var(--terracotta);
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid var(--cream);
    }
    .notes-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 14px;
      margin-bottom: 20px;
    }
    .notes-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .notes-input {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      background: var(--bg-elevated);
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
      color: var(--cream);
      font-family: var(--font-body);
      font-size: 14px;
      resize: vertical;
    }
    .notes-input:focus {
      outline: none;
      border-color: var(--terracotta-muted);
    }
    .action-row {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      border-radius: var(--radius-md);
      font-family: var(--font-body);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: var(--terracotta);
      color: var(--cream);
    }
    .btn-primary:hover { background: var(--terracotta-muted); }
    .btn-primary:active { transform: scale(0.98); }
    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-secondary);
    }
    .btn-secondary:hover {
      background: var(--bg-card);
      color: var(--cream);
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .history-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 16px;
      border-left: 3px solid var(--sage-muted);
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .history-date {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-muted);
    }
    .history-type {
      font-family: var(--font-display);
      font-size: 15px;
      color: var(--cream);
    }
    .history-meta { text-align: right; }
    .history-weight {
      font-family: var(--font-mono);
      font-size: 14px;
      color: var(--sand);
    }
    .history-energy {
      font-size: 11px;
      color: var(--text-muted);
    }
    .history-exercises {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 12px;
    }
    .history-exercises strong { color: var(--clay); }
    .history-notes {
      font-size: 12px;
      font-style: italic;
      color: var(--text-muted);
      padding: 8px 12px;
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
      margin-bottom: 12px;
    }
    .history-actions {
      display: flex;
      gap: 8px;
    }
    .btn-small {
      padding: 8px 14px;
      font-size: 12px;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-copy {
      background: var(--bg-elevated);
      color: var(--text-secondary);
    }
    .btn-copy:hover { color: var(--cream); }
    .btn-delete {
      background: transparent;
      color: var(--text-muted);
    }
    .btn-delete:hover { color: var(--danger); }
    .plan-day {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      overflow: hidden;
    }
    .plan-day-header {
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .plan-day-name {
      font-family: var(--font-display);
      font-size: 14px;
      color: var(--cream);
    }
    .plan-day-focus {
      font-size: 12px;
      color: var(--text-muted);
    }
    .plan-day-exercises {
      padding: 0 16px 16px;
      display: none;
    }
    .plan-day.expanded .plan-day-exercises { display: block; }
    .plan-exercise {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--bg-elevated);
      font-size: 13px;
    }
    .plan-exercise:last-child { border-bottom: none; }
    .plan-exercise-name { color: var(--text-secondary); }
    .plan-exercise-target {
      font-family: var(--font-mono);
      color: var(--text-muted);
      font-size: 12px;
    }
    .program-header {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 20px;
      margin-bottom: 16px;
      text-align: center;
    }
    .program-version {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--terracotta);
      margin-bottom: 8px;
    }
    .program-title {
      font-family: var(--font-display);
      font-size: 20px;
      color: var(--cream);
      margin-bottom: 4px;
    }
    .program-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }
    .update-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 16px;
    }
    .update-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--cream);
      margin-bottom: 8px;
    }
    .update-text {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 12px;
    }
    .update-textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      background: var(--bg-elevated);
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
      color: var(--cream);
      font-family: var(--font-mono);
      font-size: 12px;
      resize: vertical;
      margin-bottom: 12px;
    }
    .update-textarea:focus {
      outline: none;
      border-color: var(--terracotta-muted);
    }
    .recovery-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 16px;
    }
    .recovery-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--cream);
      margin-bottom: 12px;
    }
    .recovery-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--bg-elevated);
    }
    .recovery-item:last-child { border-bottom: none; }
    .recovery-muscle {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .recovery-status {
      font-size: 12px;
      font-family: var(--font-mono);
      padding: 4px 10px;
      border-radius: 12px;
    }
    .recovery-status.fresh {
      background: rgba(139, 157, 119, 0.2);
      color: var(--sage);
    }
    .recovery-status.recovering {
      background: rgba(212, 168, 75, 0.2);
      color: var(--warning);
    }
    .recovery-status.fatigued {
      background: rgba(199, 99, 62, 0.2);
      color: var(--terracotta);
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-main);
      border-top: 1px solid var(--bg-elevated);
      padding: 8px 16px 24px;
      display: none;
    }
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-elevated);
      color: var(--cream);
      padding: 12px 20px;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 200;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .saved-indicator {
      position: fixed;
      top: 20px;
      right: 16px;
      background: var(--sage-muted);
      color: var(--cream);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 200;
    }
    .saved-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="saved-indicator" id="savedIndicator">Saved</div>
  <div class="toast" id="toast"></div>
  
  <header class="header">
    <div class="header-top">
      <div class="logo">Protocol</div>
      <div class="week-badge">
        <span class="number" id="weekNumber">52</span>
        <span class="label">weeks out</span>
      </div>
    </div>
    <div class="phase-banner">
      <div class="phase-info">
        <div class="phase-name" id="phaseName">Phase 1: Hypertrophy</div>
        <div class="phase-detail" id="phaseDetail">Weeks 52-40 â€¢ Push/Pull/Legs</div>
      </div>
      <div class="phase-progress">
        <div class="bar"><div class="bar-fill" id="phaseProgress" style="width: 0%"></div></div>
        <div class="text" id="phaseProgressText">0/12 weeks</div>
      </div>
    </div>
  </header>
  
  <div class="alerts" id="alerts"></div>
  
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="statWorkouts">0</div>
      <div class="stat-label">Workouts</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="statVolume">0</div>
      <div class="stat-label">Total Sets</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="statStreak">0</div>
      <div class="stat-label">Day Streak</div>
    </div>
  </div>
  
  <nav class="tabs">
    <button class="tab active" data-tab="log">Log</button>
    <button class="tab" data-tab="history">History</button>
    <button class="tab" data-tab="plan">Plan</button>
    <button class="tab" data-tab="program">Program</button>
  </nav>
  
  <main class="content">
    <div class="tab-content active" id="tab-log">
      <div class="workout-grid" id="workoutGrid"></div>
      <div id="exerciseList"></div>
      <div class="metrics-row">
        <div class="metric-card">
          <div class="metric-label">Bodyweight (lbs)</div>
          <input type="text" class="metric-input" id="bodyweight" inputmode="decimal" placeholder="215">
        </div>
        <div class="metric-card">
          <div class="metric-label">Sleep Hours</div>
          <input type="text" class="metric-input" id="sleepHours" inputmode="decimal" placeholder="7.5">
        </div>
      </div>
      <div class="energy-card">
        <div class="energy-header">
          <span class="energy-label">Energy Level</span>
          <span class="energy-value" id="energyValue">7</span>
        </div>
        <input type="range" class="energy-slider" id="energySlider" min="1" max="10" value="7">
      </div>
      <div class="notes-card">
        <div class="notes-label">Session Notes</div>
        <textarea class="notes-input" id="sessionNotes" placeholder="How did the workout feel?"></textarea>
      </div>
      <div class="action-row">
        <button class="btn btn-secondary" onclick="clearForm()">Clear</button>
        <button class="btn btn-primary" onclick="saveWorkout()">Save Workout</button>
      </div>
    </div>
    
    <div class="tab-content" id="tab-history">
      <div class="history-list" id="historyList"></div>
    </div>
    
    <div class="tab-content" id="tab-plan">
      <div id="planView"></div>
    </div>
    
    <div class="tab-content" id="tab-program">
      <div class="program-header">
        <div class="program-version" id="programVersion">v1.0</div>
        <div class="program-title" id="programTitle">Competition Prep</div>
        <div class="program-subtitle" id="programSubtitle">52-Week Journey to Stage</div>
      </div>
      <div class="recovery-card">
        <div class="recovery-title">Recovery Status</div>
        <div id="recoveryStatus"></div>
      </div>
      <div class="update-card">
        <div class="update-title">Apply Program Update</div>
        <div class="update-text">Paste updated plan.json from Claude below to update your program.</div>
        <textarea class="update-textarea" id="updateJson" placeholder='Paste JSON here...'></textarea>
        <div class="action-row">
          <button class="btn btn-secondary" onclick="exportPlan()">Export Current</button>
          <button class="btn btn-primary" onclick="applyUpdate()">Apply Update</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    let plan = null;
    let history = JSON.parse(localStorage.getItem('protocol-history') || '[]');
    let selectedWorkout = localStorage.getItem('protocol-selected') || null;
    let formData = JSON.parse(localStorage.getItem('protocol-form') || '{}');
    
    const DEFAULT_PLAN = {
      "version": "1.1",
      "name": "Competition Prep",
      "subtitle": "52-Week Journey to Stage",
      "competition_date": "2026-11-30",
      "phases": [
        { "name": "Phase 1: Hypertrophy", "weeks": "52-40", "split": "Push/Pull/Legs" },
        { "name": "Phase 2: Strength", "weeks": "39-28", "split": "Upper/Lower" },
        { "name": "Phase 3: Contest Prep", "weeks": "27-0", "split": "High Frequency" }
      ],
      "recovery_rules": {
        "posterior_chain": {
          "exercises": ["Deadlift", "Romanian Deadlift", "Smith RDL", "RDL"],
          "min_rest_hours": 48,
          "warning": "Posterior chain needs 48-72hr between heavy sessions"
        },
        "chest": {
          "exercises": ["Smith Incline Press", "Machine Chest Press", "Cable Crossover"],
          "min_rest_hours": 48,
          "warning": "Protect left pec"
        }
      },
      "workouts": {
        "Push A": {
          "focus": "Chest Emphasis",
          "exercises": [
            { "name": "Smith Incline Press", "sets": 4, "reps": "10-12", "weight": 175, "notes": "Stop at 90Â° elbow" },
            { "name": "Machine Chest Press", "sets": 3, "reps": "12", "weight": 135, "notes": "" },
            { "name": "Cable Crossover (Lowâ†’High)", "sets": 3, "reps": "15", "weight": 10, "notes": "" },
            { "name": "Smith OHP", "sets": 4, "reps": "8", "weight": 120, "notes": "" },
            { "name": "Cable Lateral Raise", "sets": 4, "reps": "15", "weight": 9.5, "notes": "" },
            { "name": "Reverse Pec Deck", "sets": 3, "reps": "15", "weight": 71, "notes": "" },
            { "name": "Overhead Cable Tricep Ext", "sets": 3, "reps": "12", "weight": 52.5, "notes": "" },
            { "name": "Cable Pushdown", "sets": 3, "reps": "12", "weight": 27.5, "notes": "" },
            { "name": "Face Pulls", "sets": 3, "reps": "15", "weight": 21.5, "notes": "" }
          ]
        },
        "Pull A": {
          "focus": "Back Width",
          "exercises": [
            { "name": "Deadlift", "sets": 4, "reps": "6", "weight": 255, "notes": "Skip Legs B for 72hr after" },
            { "name": "Lat Pulldown (Wide)", "sets": 4, "reps": "10", "weight": 105, "notes": "" },
            { "name": "Seated Cable Row", "sets": 4, "reps": "10", "weight": 120, "notes": "" },
            { "name": "Smith Bent Over Row", "sets": 3, "reps": "10", "weight": 155, "notes": "" },
            { "name": "Dumbbell Shrug", "sets": 3, "reps": "15", "weight": 65, "notes": "" },
            { "name": "Dumbbell Curl", "sets": 3, "reps": "10", "weight": 40, "notes": "" },
            { "name": "Hammer Curl", "sets": 3, "reps": "12", "weight": 40, "notes": "" },
            { "name": "Smith Reverse Curl", "sets": 3, "reps": "12", "weight": 80, "notes": "" },
            { "name": "Face Pulls", "sets": 2, "reps": "15", "weight": 21.5, "notes": "" }
          ]
        },
        "Legs A": {
          "focus": "Quad Emphasis",
          "exercises": [
            { "name": "Smith Squat", "sets": 4, "reps": "8-10", "weight": 125, "notes": "" },
            { "name": "Leg Press", "sets": 4, "reps": "12", "weight": 270, "notes": "High foot" },
            { "name": "Leg Extension", "sets": 4, "reps": "12", "weight": 150, "notes": "" },
            { "name": "Leg Curl", "sets": 4, "reps": "15", "weight": 142.5, "notes": "" },
            { "name": "Hip Adductor", "sets": 3, "reps": "15", "weight": 130, "notes": "" },
            { "name": "Hip Abductor", "sets": 3, "reps": "15", "weight": 130, "notes": "" },
            { "name": "Seated Calf Raise", "sets": 4, "reps": "15", "weight": 340, "notes": "" },
            { "name": "Cable Crunch", "sets": 3, "reps": "15", "weight": 52.5, "notes": "" },
            { "name": "Hanging Leg Raise", "sets": 3, "reps": "15", "weight": 0, "notes": "" }
          ]
        },
        "Legs B": {
          "focus": "Posterior Chain",
          "exercises": [
            { "name": "Smith RDL", "sets": 4, "reps": "10", "weight": 205, "notes": "72hr+ after deadlifts" },
            { "name": "Bulgarian Split Squat", "sets": 3, "reps": "10", "weight": 20, "notes": "Each leg" },
            { "name": "Leg Press (Low Foot)", "sets": 3, "reps": "12", "weight": 250, "notes": "" },
            { "name": "Leg Curl", "sets": 4, "reps": "12", "weight": 142.5, "notes": "" },
            { "name": "Hip Adductor", "sets": 3, "reps": "15", "weight": 130, "notes": "" },
            { "name": "Hip Abductor", "sets": 3, "reps": "15", "weight": 130, "notes": "" },
            { "name": "Smith Calf Raise", "sets": 4, "reps": "12", "weight": 135, "notes": "" },
            { "name": "Cable Crunch", "sets": 3, "reps": "15", "weight": 52.5, "notes": "" },
            { "name": "Side Plank", "sets": 2, "reps": "30s", "weight": 0, "notes": "Each side" }
          ]
        },
        "Rest": {
          "focus": "Recovery",
          "exercises": [
            { "name": "Walk", "sets": 1, "reps": "20-30 min", "weight": 0, "notes": "" },
            { "name": "Stretching", "sets": 1, "reps": "10-15 min", "weight": 0, "notes": "" },
            { "name": "Foam Rolling", "sets": 1, "reps": "10 min", "weight": 0, "notes": "" }
          ]
        }
      }
    };
    
    async function init() {
      try {
        const response = await fetch('plan.json');
        if (response.ok) {
          plan = await response.json();
          localStorage.setItem('protocol-plan', JSON.stringify(plan));
        } else { throw new Error('No external plan'); }
      } catch (e) {
        const stored = localStorage.getItem('protocol-plan');
        plan = stored ? JSON.parse(stored) : DEFAULT_PLAN;
      }
      updateProgramInfo();
      updateWeekCounter();
      updateStats();
      checkAlerts();
      updateRecoveryStatus();
      renderWorkoutButtons();
      renderPlanView();
      renderHistory();
      restoreForm();
      setupEventListeners();
    }
    
    function updateProgramInfo() {
      document.getElementById('programVersion').textContent = 'v' + (plan.version || '1.0');
      document.getElementById('programTitle').textContent = plan.name || 'Competition Prep';
      document.getElementById('programSubtitle').textContent = plan.subtitle || '';
    }
    
    function updateWeekCounter() {
      const compDate = new Date(plan.competition_date || '2026-11-30');
      const today = new Date();
      const msPerWeek = 7 * 24 * 60 * 60 * 1000;
      const weeksOut = Math.ceil((compDate - today) / msPerWeek);
      document.getElementById('weekNumber').textContent = Math.max(0, weeksOut);
      if (plan.phases && plan.phases.length > 0) {
        let currentPhase = plan.phases[0];
        for (const phase of plan.phases) {
          const [start, end] = phase.weeks.split('-').map(Number);
          if (weeksOut <= start && weeksOut >= end) { currentPhase = phase; break; }
        }
        document.getElementById('phaseName').textContent = currentPhase.name;
        document.getElementById('phaseDetail').textContent = `Weeks ${currentPhase.weeks} â€¢ ${currentPhase.split}`;
        const [start, end] = currentPhase.weeks.split('-').map(Number);
        const totalWeeks = start - end;
        const weeksCompleted = start - weeksOut;
        const progress = Math.max(0, Math.min(100, (weeksCompleted / totalWeeks) * 100));
        document.getElementById('phaseProgress').style.width = progress + '%';
        document.getElementById('phaseProgressText').textContent = `${Math.max(0, weeksCompleted)}/${totalWeeks} weeks`;
      }
    }
    
    function checkAlerts() {
      const alerts = [];
      const dismissedAlerts = JSON.parse(localStorage.getItem('protocol-dismissed-alerts') || '[]');
      if (history.length >= 1) {
        const lastWorkout = history[0];
        const lastWorkoutDate = new Date(lastWorkout.date);
        const hoursSinceLast = (new Date() - lastWorkoutDate) / (1000 * 60 * 60);
        if (plan.recovery_rules?.posterior_chain) {
          const posteriorExercises = plan.recovery_rules.posterior_chain.exercises;
          const hadPosteriorWork = lastWorkout.exercises?.some(ex => 
            posteriorExercises.some(pe => ex.name.toLowerCase().includes(pe.toLowerCase()))
          );
          if (hadPosteriorWork && hoursSinceLast < 48) {
            const alertId = 'posterior-' + lastWorkout.id;
            if (!dismissedAlerts.includes(alertId)) {
              alerts.push({
                id: alertId,
                type: 'warning',
                icon: 'âš ï¸',
                title: 'Posterior Chain Recovery',
                text: `Last workout had deadlifts/RDLs ${Math.round(hoursSinceLast)}h ago. Wait 48-72h before Legs B.`
              });
            }
          }
        }
      }
      renderAlerts(alerts);
    }
    
    function renderAlerts(alerts) {
      const container = document.getElementById('alerts');
      if (alerts.length === 0) { container.innerHTML = ''; return; }
      container.innerHTML = alerts.map(a => `
        <div class="alert ${a.type || ''}">
          <span class="alert-icon">${a.icon}</span>
          <div class="alert-content">
            <div class="alert-title">${a.title}</div>
            <div class="alert-text">${a.text}</div>
          </div>
          <button class="alert-dismiss" onclick="dismissAlert('${a.id}')">Ã—</button>
        </div>
      `).join('');
    }
    
    function dismissAlert(id) {
      const dismissed = JSON.parse(localStorage.getItem('protocol-dismissed-alerts') || '[]');
      dismissed.push(id);
      localStorage.setItem('protocol-dismissed-alerts', JSON.stringify(dismissed));
      checkAlerts();
    }
    
    function updateRecoveryStatus() {
      const container = document.getElementById('recoveryStatus');
      if (!plan.recovery_rules) {
        container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No recovery rules</div>';
        return;
      }
      const muscleGroups = [
        { name: 'Posterior Chain', key: 'posterior_chain' },
        { name: 'Chest', key: 'chest' }
      ];
      container.innerHTML = muscleGroups.map(group => {
        const rules = plan.recovery_rules[group.key];
        if (!rules) return '';
        const lastWorkout = history.find(h => 
          h.exercises?.some(ex => 
            rules.exercises.some(re => ex.name.toLowerCase().includes(re.toLowerCase()))
          )
        );
        let status = 'fresh';
        let statusText = 'Ready';
        if (lastWorkout) {
          const hoursSince = (new Date() - new Date(lastWorkout.date)) / (1000 * 60 * 60);
          if (hoursSince < rules.min_rest_hours) {
            status = 'fatigued';
            statusText = `${Math.round(rules.min_rest_hours - hoursSince)}h left`;
          } else if (hoursSince < rules.min_rest_hours * 1.5) {
            status = 'recovering';
            statusText = 'Recovered';
          }
        }
        return `<div class="recovery-item"><span class="recovery-muscle">${group.name}</span><span class="recovery-status ${status}">${statusText}</span></div>`;
      }).join('');
    }
    
    function updateStats() {
      document.getElementById('statWorkouts').textContent = history.length;
      const totalSets = history.reduce((sum, w) => sum + (w.exercises?.reduce((s, ex) => s + (ex.sets?.length || 0), 0) || 0), 0);
      document.getElementById('statVolume').textContent = totalSets;
      let streak = 0;
      const today = new Date(); today.setHours(0, 0, 0, 0);
      for (let i = 0; i < 365; i++) {
        const checkDate = new Date(today - i * 24 * 60 * 60 * 1000);
        const dateStr = checkDate.toISOString().split('T')[0];
        const hasWorkout = history.some(h => h.date?.startsWith(dateStr));
        if (hasWorkout) { streak++; } else if (i > 0) { break; }
      }
      document.getElementById('statStreak').textContent = streak;
    }
    
    function renderWorkoutButtons() {
      const container = document.getElementById('workoutGrid');
      if (!plan?.workouts) return;
      container.innerHTML = Object.entries(plan.workouts).map(([name, data]) => `
        <button class="workout-btn ${name === 'Rest' ? 'rest' : ''} ${selectedWorkout === name ? 'selected' : ''}" onclick="selectWorkout('${name}')">
          <div class="name">${name}</div>
          <div class="focus">${data.focus}</div>
        </button>
      `).join('');
    }
    
    function selectWorkout(name) {
      selectedWorkout = name;
      localStorage.setItem('protocol-selected', name);
      renderWorkoutButtons();
      renderExercises();
    }
    
    function renderExercises() {
      const container = document.getElementById('exerciseList');
      if (!selectedWorkout || !plan?.workouts?.[selectedWorkout]) { container.innerHTML = ''; return; }
      const workout = plan.workouts[selectedWorkout];
      const exercises = workout.exercises || [];
      container.innerHTML = `
        <div class="exercise-section">
          <div class="section-header">
            <div class="section-title">${workout.focus}</div>
            <div class="section-count">${exercises.length} exercises</div>
          </div>
          ${exercises.map((ex, i) => renderExerciseCard(ex, i)).join('')}
        </div>
      `;
      restoreExerciseData();
    }
    
    function renderExerciseCard(ex, index) {
      const numSets = ex.sets || 3;
      const setsHtml = Array.from({ length: numSets }, (_, setIdx) => `
        <div class="sets-row">
          <div class="set-input-group">
            <div class="set-label">Set ${setIdx + 1} Weight</div>
            <input type="text" class="set-input" inputmode="decimal" data-ex="${index}" data-set="${setIdx}" data-type="weight" placeholder="${ex.weight || ''}">
          </div>
          <div class="set-input-group">
            <div class="set-label">Reps</div>
            <input type="text" class="set-input" inputmode="numeric" data-ex="${index}" data-set="${setIdx}" data-type="reps" placeholder="${ex.reps || ''}">
          </div>
        </div>
      `).join('');
      return `
        <div class="exercise-card" id="ex-${index}">
          <div class="exercise-header" onclick="toggleExercise(${index})">
            <span class="exercise-name">${ex.name}</span>
            <span class="exercise-target">${ex.sets}Ã—${ex.reps} @ ${ex.weight}</span>
          </div>
          <div class="exercise-sets">
            ${ex.notes ? `<div class="exercise-note">${ex.notes}</div>` : ''}
            ${setsHtml}
          </div>
        </div>
      `;
    }
    
    function toggleExercise(index) {
      document.getElementById('ex-' + index).classList.toggle('expanded');
    }
    
    function restoreForm() {
      if (formData.bodyweight) document.getElementById('bodyweight').value = formData.bodyweight;
      if (formData.sleepHours) document.getElementById('sleepHours').value = formData.sleepHours;
      if (formData.energy) {
        document.getElementById('energySlider').value = formData.energy;
        document.getElementById('energyValue').textContent = formData.energy;
      }
      if (formData.notes) document.getElementById('sessionNotes').value = formData.notes;
      if (formData.selectedWorkout) {
        selectedWorkout = formData.selectedWorkout;
        localStorage.setItem('protocol-selected', selectedWorkout);
        renderWorkoutButtons();
        renderExercises();
      }
    }
    
    function restoreExerciseData() {
      if (!formData.exercises) return;
      document.querySelectorAll('.set-input').forEach(input => {
        const key = `${input.dataset.ex}-${input.dataset.set}-${input.dataset.type}`;
        if (formData.exercises[key]) {
          input.value = formData.exercises[key];
          input.classList.add('filled');
        }
      });
    }
    
    function saveFormData() {
      formData = {
        bodyweight: document.getElementById('bodyweight').value,
        sleepHours: document.getElementById('sleepHours').value,
        energy: document.getElementById('energySlider').value,
        notes: document.getElementById('sessionNotes').value,
        selectedWorkout: selectedWorkout,
        exercises: {}
      };
      document.querySelectorAll('.set-input').forEach(input => {
        const key = `${input.dataset.ex}-${input.dataset.set}-${input.dataset.type}`;
        if (input.value) formData.exercises[key] = input.value;
      });
      localStorage.setItem('protocol-form', JSON.stringify(formData));
      showSaved();
    }
    
    function showSaved() {
      const indicator = document.getElementById('savedIndicator');
      indicator.classList.add('show');
      setTimeout(() => indicator.classList.remove('show'), 1500);
    }
    
    function clearForm() {
      document.getElementById('bodyweight').value = '';
      document.getElementById('sleepHours').value = '';
      document.getElementById('energySlider').value = 7;
      document.getElementById('energyValue').textContent = '7';
      document.getElementById('sessionNotes').value = '';
      document.querySelectorAll('.set-input').forEach(input => {
        input.value = '';
        input.classList.remove('filled');
      });
      formData = {};
      localStorage.removeItem('protocol-form');
      showToast('Form cleared');
    }
    
    function saveWorkout() {
      if (!selectedWorkout) { showToast('Select a workout first'); return; }
      const workout = plan.workouts[selectedWorkout];
      const exercises = [];
      workout.exercises.forEach((ex, exIdx) => {
        const sets = [];
        for (let setIdx = 0; setIdx < (ex.sets || 3); setIdx++) {
          const weightInput = document.querySelector(`[data-ex="${exIdx}"][data-set="${setIdx}"][data-type="weight"]`);
          const repsInput = document.querySelector(`[data-ex="${exIdx}"][data-set="${setIdx}"][data-type="reps"]`);
          if (weightInput?.value || repsInput?.value) {
            sets.push({ weight: parseFloat(weightInput?.value) || 0, reps: parseInt(repsInput?.value) || 0 });
          }
        }
        if (sets.length > 0) exercises.push({ name: ex.name, sets });
      });
      const entry = {
        id: Date.now(),
        date: new Date().toISOString(),
        type: selectedWorkout,
        focus: workout.focus,
        bodyweight: parseFloat(document.getElementById('bodyweight').value) || null,
        sleepHours: parseFloat(document.getElementById('sleepHours').value) || null,
        energy: parseInt(document.getElementById('energySlider').value),
        notes: document.getElementById('sessionNotes').value,
        exercises
      };
      history.unshift(entry);
      localStorage.setItem('protocol-history', JSON.stringify(history));
      clearForm();
      updateStats();
      checkAlerts();
      updateRecoveryStatus();
      renderHistory();
      showToast('Workout saved!');
    }
    
    function renderHistory() {
      const container = document.getElementById('historyList');
      if (history.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ðŸ“‹</div><div class="empty-state-text">No workouts logged yet</div></div>`;
        return;
      }
      container.innerHTML = history.map(w => {
        const date = new Date(w.date);
        const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        return `
          <div class="history-card">
            <div class="history-header">
              <div>
                <div class="history-date">${dateStr}</div>
                <div class="history-type">${w.type}</div>
              </div>
              <div class="history-meta">
                ${w.bodyweight ? `<div class="history-weight">${w.bodyweight} lbs</div>` : ''}
                <div class="history-energy">Energy: ${w.energy}/10</div>
              </div>
            </div>
            <div class="history-exercises">
              ${w.exercises?.map(ex => `<strong>${ex.name}:</strong> ${ex.sets.map(s => s.weight + 'Ã—' + s.reps).join(', ')}`).join('<br>') || 'No exercises logged'}
            </div>
            ${w.notes ? `<div class="history-notes">${w.notes}</div>` : ''}
            <div class="history-actions">
              <button class="btn-small btn-copy" onclick="copyWorkout(${w.id})">Copy for Claude</button>
              <button class="btn-small btn-delete" onclick="deleteWorkout(${w.id})">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function copyWorkout(id) {
      const w = history.find(h => h.id === id);
      if (!w) return;
      const text = `DATE: ${new Date(w.date).toLocaleDateString()}\nWORKOUT: ${w.type} (${w.focus})\nBODYWEIGHT: ${w.bodyweight || '-'} lbs\nSLEEP: ${w.sleepHours || '-'} hours\nENERGY: ${w.energy}/10\n\nEXERCISES:\n${w.exercises?.map(ex => `${ex.name}: ${ex.sets.map(s => s.weight + 'x' + s.reps).join(', ')}`).join('\n') || 'None logged'}\n\nNOTES: ${w.notes || 'None'}`;
      navigator.clipboard.writeText(text);
      showToast('Copied to clipboard');
    }
    
    function deleteWorkout(id) {
      if (confirm('Delete this workout?')) {
        history = history.filter(h => h.id !== id);
        localStorage.setItem('protocol-history', JSON.stringify(history));
        updateStats();
        checkAlerts();
        updateRecoveryStatus();
        renderHistory();
        showToast('Workout deleted');
      }
    }
    
    function renderPlanView() {
      const container = document.getElementById('planView');
      if (!plan?.workouts) return;
      container.innerHTML = Object.entries(plan.workouts).map(([name, data]) => `
        <div class="plan-day" id="plan-${name.replace(/\s/g, '-')}">
          <div class="plan-day-header" onclick="togglePlanDay('${name.replace(/\s/g, '-')}')">
            <span class="plan-day-name">${name}</span>
            <span class="plan-day-focus">${data.focus}</span>
          </div>
          <div class="plan-day-exercises">
            ${(data.exercises || []).map(ex => `
              <div class="plan-exercise">
                <span class="plan-exercise-name">${ex.name}</span>
                <span class="plan-exercise-target">${ex.sets}Ã—${ex.reps} @ ${ex.weight}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }
    
    function togglePlanDay(name) {
      document.getElementById('plan-' + name).classList.toggle('expanded');
    }
    
    function applyUpdate() {
      const textarea = document.getElementById('updateJson');
      const json = textarea.value.trim();
      if (!json) { showToast('Paste JSON first'); return; }
      try {
        const newPlan = JSON.parse(json);
        if (!newPlan.workouts) throw new Error('Invalid plan: missing workouts');
        plan = newPlan;
        localStorage.setItem('protocol-plan', JSON.stringify(plan));
        updateProgramInfo();
        updateWeekCounter();
        checkAlerts();
        updateRecoveryStatus();
        renderWorkoutButtons();
        renderPlanView();
        textarea.value = '';
        showToast('Program updated!');
      } catch (e) {
        showToast('Invalid JSON: ' + e.message);
      }
    }
    
    function exportPlan() {
      navigator.clipboard.writeText(JSON.stringify(plan, null, 2));
      showToast('Plan copied to clipboard');
    }
    
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }
    
    function setupEventListeners() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        });
      });
      document.getElementById('energySlider').addEventListener('input', (e) => {
        document.getElementById('energyValue').textContent = e.target.value;
        saveFormData();
      });
      document.addEventListener('input', (e) => {
        if (e.target.classList.contains('set-input')) {
          e.target.classList.toggle('filled', !!e.target.value);
          saveFormData();
        } else if (['bodyweight', 'sleepHours', 'sessionNotes'].includes(e.target.id)) {
          saveFormData();
        }
      });
    }
    
    init();
  </script>
</body>
</html>
